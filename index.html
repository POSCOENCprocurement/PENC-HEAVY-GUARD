<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HeavyGuard AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- AI Core -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>

    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- iOS Style Reset & Base --- */
        body { 
            background-color: #000; 
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }
        
        .safe-area-top { padding-top: max(44px, env(safe-area-inset-top)); }
        .safe-area-bottom { padding-bottom: max(34px, env(safe-area-inset-bottom)); }
        
        /* --- Apple Glassmorphism --- */
        .ios-glass {
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
        }
        
        .ios-glass-dark {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Dynamic Island Alert --- */
        .dynamic-island {
            background: #000;
            border-radius: 36px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .dynamic-island.danger { background: #FF3B30; } /* iOS Red */
        .dynamic-island.warning { background: #FF9500; } /* iOS Orange */

        /* --- Shutter Button --- */
        .shutter-button {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 1);
            padding: 3px;
            background: transparent;
            transition: transform 0.1s;
        }
        .shutter-inner {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .shutter-button:active { transform: scale(0.95); }
        .shutter-button:active .shutter-inner { background: #e5e5e5; transform: scale(0.9); }
        .shutter-button:disabled { opacity: 0.5; }

        /* --- Circle Icon Button (Dock) --- */
        .dock-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .dock-btn.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
            border: none;
        }
        .dock-btn:active { transform: scale(0.92); }

        /* --- Chat Bubbles --- */
        .chat-bubble-user {
            background: #007AFF;
            color: white;
            border-radius: 18px 18px 2px 18px;
            padding: 10px 14px;
            max-width: 80%;
            align-self: flex-end;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-bubble-ai {
            background: #2C2C2E;
            color: #fff;
            border-radius: 18px 18px 18px 2px;
            padding: 10px 14px;
            max-width: 80%;
            align-self: flex-start;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Animations --- */
        @keyframes scan-line {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { top: 100%; opacity: 0; }
        }
        .scanner {
            position: absolute; left: 0; width: 100%; height: 2px;
            background: #007AFF;
            box-shadow: 0 0 10px #007AFF;
            animation: scan-line 2s linear infinite;
        }

        /* --- Utils --- */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        button { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px;
            border-radius: 50%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; background: rgba(255,255,255,0.3);
        }

        /* Print */
        @media print {
            body * { visibility: hidden; }
            #report-section, #report-section * { visibility: visible; }
            #report-section { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; color: black; z-index: 9999; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Icons (Lucide) ---
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Eye: (p) => <Icon {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>,
            EyeOff: (p) => <Icon {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></Icon>,
            Camera: (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>,
            Siren: (p) => <Icon {...p}><path d="M7 18v-6a5 5 0 1 1 10 0v6"/><path d="M5 21a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/><path d="M21 11.343l-3.34-1.67"/><path d="M3 11.343l3.34-1.67"/></Icon>,
            Flash: (p) => <Icon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>,
            FlashOff: (p) => <Icon {...p}><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/><line x1="1" y1="1" x2="23" y2="23"/></Icon>,
            RotateCcw: (p) => <Icon {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>,
            Loader: (p) => <Icon {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>,
            Sparkles: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></Icon>,
            Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
            ZoomIn: (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></Icon>,
            Key: (p) => <Icon {...p}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></Icon>,
            MessageSquare: (p) => <Icon {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>,
            Send: (p) => <Icon {...p}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>
        };

        // --- Gemini API Wrapper ---
        async function callGeminiAPI(prompt, base64Image, apiKey) {
            if (!apiKey) return { success: false, errorType: 'AUTH', message: "API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§." };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const requestBody = { contents: [{ parts: [{ text: prompt }, ...(base64Image ? [{ inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }] : []) ] }] };
            
            let retries = 0; const maxRetries = 2;
            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    const data = await response.json();
                    if (!response.ok) {
                        if (response.status === 400 || response.status === 403) return { success: false, errorType: 'AUTH', message: "API ÌÇ§ Ïò§Î•ò" };
                        throw new Error(data.error?.message || "HTTP Error");
                    }
                    return { success: true, text: data.candidates?.[0]?.content?.parts?.[0]?.text || "ÎãµÎ≥Ä Î∂àÍ∞Ä" };
                } catch (error) {
                    retries++;
                    if (retries > maxRetries) return { success: false, errorType: 'NETWORK', message: "Ïó∞Í≤∞ Ïã§Ìå®" };
                    await new Promise(r => setTimeout(r, 1000 * retries));
                }
            }
        }

        const App = () => {
            const [monitoringOn, setMonitoringOn] = useState(true);
            const [apiKey, setApiKey] = useState('');
            const [isKeyModalOpen, setIsKeyModalOpen] = useState(false);
            
            // Core States
            const [modelLoaded, setModelLoaded] = useState(false);
            const [alertState, setAlertState] = useState(null); 
            const [warningMsg, setWarningMsg] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [showReport, setShowReport] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);

            // Chat Assistant State
            const [showChat, setShowChat] = useState(false);
            const [chatMessages, setChatMessages] = useState([
                { sender: 'ai', text: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! KOSHA ÏïàÏ†Ñ Í∞ÄÏù¥Îìú ÎπÑÏÑúÏûÖÎãàÎã§. ÏûëÏóÖ ÌòÑÏû• ÏïàÏ†Ñ ÏàòÏπôÏù¥ÎÇò Í∏∞Ï§ÄÏóê ÎåÄÌï¥ Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî. (Ïòà: ÎπÑÍ≥Ñ ÏÑ§Ïπò Í∏∞Ï§Ä, Î∞ÄÌèêÍ≥µÍ∞Ñ ÏàòÏπô)' }
            ]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Camera Features
            const [videoTrack, setVideoTrack] = useState(null);
            const [capabilities, setCapabilities] = useState({});
            const [zoom, setZoom] = useState(1);
            const [flashOn, setFlashOn] = useState(false);
            const [cameras, setCameras] = useState([]);
            const [currentCameraIdx, setCurrentCameraIdx] = useState(0);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const modelRef = useRef(null);
            const requestRef = useRef(null);
            const streamRef = useRef(null);

            // Init
            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setApiKey(storedKey);
                else setTimeout(() => setIsKeyModalOpen(true), 1500);

                navigator.mediaDevices.enumerateDevices().then(devices => {
                    const vids = devices.filter(d => d.kind === 'videoinput');
                    let backs = vids.filter(d => /back|rear|environment/i.test(d.label));
                    setCameras(backs.length > 0 ? backs : vids);
                });

                cocoSsd.load({ base: 'lite_mobilenet_v2' }).then(model => {
                    modelRef.current = model;
                    setModelLoaded(true);
                    startCamera();
                });

                return () => cancelAnimationFrame(requestRef.current);
            }, []);

            // Scroll Chat to Bottom
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages, showChat]);

            const startCamera = async (deviceId = null) => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            facingMode: deviceId ? undefined : 'environment',
                            width: { ideal: 1920 }, height: { ideal: 1080 }
                        }, audio: false
                    });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        const track = stream.getVideoTracks()[0];
                        setVideoTrack(track);
                        setTimeout(() => {
                            setCapabilities(track.getCapabilities ? track.getCapabilities() : {});
                            setZoom(1); setFlashOn(false);
                        }, 500);
                        videoRef.current.onloadeddata = predictLoop;
                    }
                } catch (e) { console.error(e); }
            };

            const toggleFlash = async () => {
                if (!videoTrack) return;
                try { await videoTrack.applyConstraints({ advanced: [{ torch: !flashOn }] }); setFlashOn(!flashOn); } catch(e){}
            };

            const switchCamera = () => {
                if (cameras.length < 2) return;
                const nextIdx = (currentCameraIdx + 1) % cameras.length;
                setCurrentCameraIdx(nextIdx);
                startCamera(cameras[nextIdx].deviceId);
            };

            const handleZoom = async (e) => {
                const z = parseFloat(e.target.value);
                setZoom(z);
                if (videoTrack) try { await videoTrack.applyConstraints({ advanced: [{ zoom: z }] }); } catch(e){}
            };

            const predictLoop = async () => {
                if (!modelRef.current || !videoRef.current || !canvasRef.current) return;
                if (videoRef.current.readyState < 2) { requestRef.current = requestAnimationFrame(predictLoop); return; }

                const ctx = canvasRef.current.getContext('2d');
                if (canvasRef.current.width !== videoRef.current.videoWidth) {
                    canvasRef.current.width = videoRef.current.videoWidth;
                    canvasRef.current.height = videoRef.current.videoHeight;
                }
                ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);

                if (!monitoringOn) {
                    setAlertState(null); setWarningMsg(''); requestRef.current = requestAnimationFrame(predictLoop); return;
                }

                const predictions = await modelRef.current.detect(videoRef.current);
                let pCount = 0, eCount = 0;

                predictions.forEach(pred => {
                    if (pred.score < 0.55) return;
                    const [x, y, w, h] = pred.bbox;
                    let label = pred.class;
                    let color = '#34C759';

                    if (label === 'person') { pCount++; label = 'Í∑ºÎ°úÏûê'; color = '#007AFF'; } 
                    else if (['truck', 'car', 'bus'].includes(label)) { eCount++; label = 'Ïû•ÎπÑ'; color = '#FF9500'; } 
                    else return;

                    ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4;
                    ctx.strokeStyle = color; ctx.lineWidth = 4;
                    ctx.strokeRect(x, y, w, h);

                    ctx.fillStyle = color;
                    const text = label;
                    const tw = ctx.measureText(text).width;
                    ctx.fillRect(x, y - 30, tw + 20, 30);
                    ctx.fillStyle = '#fff';
                    ctx.font = '600 16px -apple-system';
                    ctx.fillText(text, x + 10, y - 9);
                });

                if (pCount > 0 && eCount > 0) { setAlertState('danger'); setWarningMsg('‚ö†Ô∏è Ï∂©Îèå ÏúÑÌóò: Ïû•ÎπÑ Ï†ëÍ∑º'); }
                else if (eCount > 0) { setAlertState('warning'); setWarningMsg('Ï£ºÏùò: Ïû•ÎπÑ Í∞ÄÎèô Ï§ë'); }
                else { setAlertState(null); setWarningMsg(''); }

                requestRef.current = requestAnimationFrame(predictLoop);
            };

            const analyzeSnapshot = async () => {
                if (!apiKey) { setIsKeyModalOpen(true); return; }
                setIsAnalyzing(true);
                
                const flashDiv = document.createElement('div');
                flashDiv.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;opacity:0.8;transition:opacity 0.2s';
                document.body.appendChild(flashDiv);
                setTimeout(() => { flashDiv.style.opacity = '0'; setTimeout(() => flashDiv.remove(), 200) }, 50);

                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = videoRef.current.videoWidth;
                    canvas.height = videoRef.current.videoHeight;
                    canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                    const base64Img = canvas.toDataURL('image/jpeg', 0.8);
                    setCapturedImage(base64Img);

                    const prompt = `KOSHA(ÏïàÏ†ÑÎ≥¥Í±¥Í≥µÎã®) Í∏∞Ï§Ä ÌòÑÏû• ÏïàÏ†Ñ Ï†ïÎ∞Ä ÏßÑÎã®. 
                    ÌïµÏã¨ Ï†êÍ≤Ä: 1.Ïû•ÎπÑÏ†ÑÎèÑ/ÌòëÏ∞© 2.Ï∂îÎùΩ/Í∞úÍµ¨Î∂Ä 3.ÏïàÏ†ÑÍ≥†Î¶¨/Î≥¥Ìò∏Íµ¨ 4.ÌôîÏû¨/Í∞êÏ†Ñ. 
                    Í≤∞Í≥ºÎäî ÎßàÌÅ¨Îã§Ïö¥ Î≥¥Í≥†ÏÑú ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±.`;
                    
                    const result = await callGeminiAPI(prompt, base64Img, apiKey);
                    if (result.success) { setAnalysisResult(result.text); setShowReport(true); }
                    else { alert(result.message); if (result.errorType==='AUTH') setIsKeyModalOpen(true); }
                } catch (e) { alert("Î∂ÑÏÑù Ïò§Î•ò"); }
                setIsAnalyzing(false);
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim() || isChatLoading) return;
                
                const userMsg = chatInput;
                setChatMessages(prev => [...prev, { sender: 'user', text: userMsg }]);
                setChatInput('');
                setIsChatLoading(true);

                if (!apiKey) {
                    setChatMessages(prev => [...prev, { sender: 'ai', text: 'API ÌÇ§ ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Ïö∞Ï∏° ÏÉÅÎã® ÏÑ§Ï†ï Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.' }]);
                    setIsChatLoading(false);
                    return;
                }

                const prompt = `ÎãπÏã†ÏùÄ ÎåÄÌïúÎØºÍµ≠ KOSHA(ÏïàÏ†ÑÎ≥¥Í±¥Í≥µÎã®) Í∞ÄÏù¥ÎìúÎ•º Ï§ÄÏàòÌïòÎäî Í±¥ÏÑ§ ÏïàÏ†Ñ Ï†ÑÎ¨∏Í∞Ä AI Ï±óÎ¥áÏûÖÎãàÎã§. 
                ÏÇ¨Ïö©ÏûêÏùò ÏßàÎ¨∏: "${userMsg}"
                ÎãµÎ≥ÄÏùÄ ÌòÑÏû• ÏûëÏóÖÏûêÍ∞Ä Ïù¥Ìï¥ÌïòÍ∏∞ ÏâΩÍ≤å KOSHA Í∏∞Ï§Ä, Î≤ïÏ†Å Í∏∞Ï§Ä, Í∂åÏû• ÏïàÏ†Ñ ÏàòÏπôÏùÑ Í∑ºÍ±∞Î°ú Í∞ÑÍ≤∞ÌïòÍ≤å ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî.`;

                const result = await callGeminiAPI(prompt, null, apiKey);
                const aiText = result.success ? result.text : `Ïò§Î•ò Î∞úÏÉù: ${result.message}`;
                
                setChatMessages(prev => [...prev, { sender: 'ai', text: aiText }]);
                setIsChatLoading(false);
            };

            return (
                <div className="relative h-full w-full bg-black">
                    {/* Viewfinder */}
                    <video ref={videoRef} autoPlay playsInline muted className="absolute inset-0 w-full h-full object-cover"></video>
                    <canvas ref={canvasRef} className="absolute inset-0 w-full h-full object-cover"></canvas>
                    
                    {/* Top Bar */}
                    <div className="absolute top-0 w-full p-4 safe-area-top z-30 flex flex-col items-center">
                        {(alertState && monitoringOn) ? (
                            <div className={`dynamic-island ${alertState} px-6 py-3 flex items-center gap-3 animate-bounce`}>
                                {alertState === 'danger' ? <Icons.AlertTriangle className="text-white fill-white/20"/> : <Icons.Siren className="text-white"/>}
                                <span className="text-white font-bold text-sm tracking-tight">{warningMsg}</span>
                            </div>
                        ) : (
                            <div className="ios-glass rounded-full px-4 py-1.5 flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${monitoringOn ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-gray-500'}`}></div>
                                <span className="text-xs font-medium text-white/90">HeavyGuard AI</span>
                            </div>
                        )}

                        <div className="absolute right-4 top-4 safe-area-top flex gap-3">
                            {capabilities.torch && (
                                <button onClick={toggleFlash} className={`p-2 rounded-full backdrop-blur transition-colors ${flashOn ? 'bg-yellow-400 text-black' : 'bg-black/30 text-white'}`}>
                                    {flashOn ? <Icons.Flash size={18}/> : <Icons.FlashOff size={18}/>}
                                </button>
                            )}
                            <button onClick={() => setIsKeyModalOpen(true)} className="p-2 rounded-full bg-black/30 backdrop-blur text-white">
                                <Icons.Settings size={18}/>
                            </button>
                        </div>
                    </div>

                    {/* Right Side Controls */}
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 z-20 flex flex-col items-center gap-6">
                        {cameras.length > 1 && (
                            <button onClick={switchCamera} className="p-3 rounded-full bg-black/40 backdrop-blur text-white shadow-lg active:rotate-180 transition-transform">
                                <Icons.RotateCcw size={20}/>
                            </button>
                        )}
                        {capabilities.zoom && (
                            <div className="bg-black/40 backdrop-blur rounded-full py-4 w-10 h-48 flex flex-col items-center justify-center relative">
                                <span className="absolute top-3 text-[10px] font-bold opacity-80">Zoom</span>
                                <input type="range" min={capabilities.zoom.min} max={capabilities.zoom.max} step="0.1" 
                                    value={zoom} onChange={handleZoom}
                                    className="w-32 h-10 -rotate-90 origin-center absolute top-20"
                                />
                                <span className="absolute bottom-3 text-[10px] font-mono opacity-80">{zoom.toFixed(1)}x</span>
                            </div>
                        )}
                    </div>

                    {/* --- Bottom Dock (3-Column Layout) --- */}
                    <div className="absolute bottom-0 w-full safe-area-bottom pb-6 pt-4 bg-gradient-to-t from-black/90 to-transparent z-30 px-8">
                        <div className="flex justify-between items-end max-w-sm mx-auto">
                            
                            {/* 1. Monitoring Toggle (Left) */}
                            <div className="flex flex-col items-center gap-2 mb-1 w-16">
                                <button 
                                    onClick={() => setMonitoringOn(!monitoringOn)}
                                    className={`dock-btn ${monitoringOn ? 'active' : ''}`}
                                >
                                    {monitoringOn ? <Icons.Eye size={24}/> : <Icons.EyeOff size={24} className="opacity-50"/>}
                                </button>
                                <span className="text-[10px] font-medium text-white/80 shadow-black drop-shadow-md">Î™®ÎãàÌÑ∞ÎßÅ</span>
                            </div>

                            {/* 2. AI Diagnosis Shutter (Center) */}
                            <div className="flex flex-col items-center gap-2 -mb-2">
                                <button 
                                    onClick={analyzeSnapshot} 
                                    disabled={isAnalyzing || !modelLoaded}
                                    className="shutter-button shadow-[0_0_20px_rgba(0,0,0,0.5)] transform active:scale-95 transition-transform"
                                >
                                    <div className="shutter-inner flex items-center justify-center">
                                        {isAnalyzing ? <Icons.Loader className="text-gray-500 animate-spin" size={32}/> : <Icons.Sparkles className="text-black" size={32}/>}
                                    </div>
                                </button>
                                <span className="text-[11px] font-bold text-white shadow-black drop-shadow-md mb-2">Ï†ïÎ∞Ä ÏßÑÎã®</span>
                            </div>

                            {/* 3. AI Safety Assistant (Right) */}
                            <div className="flex flex-col items-center gap-2 mb-1 w-16">
                                <button 
                                    onClick={() => setShowChat(true)}
                                    className="dock-btn text-white hover:bg-white/20 active:bg-[#007AFF]"
                                >
                                    <Icons.MessageSquare size={24}/>
                                </button>
                                <span className="text-[10px] font-medium text-white/80 shadow-black drop-shadow-md">AI ÎπÑÏÑú</span>
                            </div>

                        </div>
                    </div>

                    {/* --- Chat Modal --- */}
                    {showChat && (
                        <div className="absolute inset-0 z-50 bg-[#1C1C1E] flex flex-col animate-[slideUp_0.3s_ease-out]">
                            {/* Header */}
                            <div className="bg-[#2C2C2E] border-b border-gray-700 p-4 safe-area-top flex justify-between items-center shadow-md z-10">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                    <span className="bg-[#007AFF] p-1 rounded-md"><Icons.MessageSquare size={16} className="text-white"/></span> AI ÏïàÏ†ÑÎπÑÏÑú
                                </h2>
                                <button onClick={() => setShowChat(false)} className="bg-[#3A3A3C] p-2 rounded-full text-gray-300 hover:text-white">
                                    <Icons.X size={20}/>
                                </button>
                            </div>
                            
                            {/* Messages */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-4">
                                {chatMessages.map((msg, idx) => (
                                    <div key={idx} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'}`}>
                                        <div className={msg.sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}>
                                            <div className="text-sm leading-relaxed whitespace-pre-wrap">
                                                {msg.sender === 'ai' ? marked.parse(msg.text).replace(/<[^>]+>/g, '') : msg.text} 
                                                {/* Simple parse for markdown in chat */}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {isChatLoading && (
                                    <div className="flex justify-start">
                                        <div className="chat-bubble-ai flex items-center gap-2">
                                            <Icons.Loader size={16} className="animate-spin text-gray-400"/>
                                            <span className="text-xs text-gray-400">ÎãµÎ≥Ä ÏûëÏÑ± Ï§ë...</span>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef} />
                            </div>

                            {/* Input Area */}
                            <div className="p-4 bg-[#2C2C2E] border-t border-gray-700 safe-area-bottom">
                                <form onSubmit={handleChatSubmit} className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        placeholder="ÏïàÏ†Ñ Í∏∞Ï§ÄÏóê ÎåÄÌï¥ Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî..." 
                                        className="flex-1 bg-[#1C1C1E] text-white px-4 py-3 rounded-2xl border border-gray-600 focus:border-[#007AFF] outline-none text-sm placeholder:text-gray-500"
                                    />
                                    <button type="submit" disabled={isChatLoading} 
                                        className="bg-[#007AFF] text-white p-3 rounded-full disabled:opacity-50 disabled:bg-gray-600">
                                        <Icons.Send size={20}/>
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Report Modal */}
                    {showReport && (
                        <div id="report-section" className="absolute inset-0 z-50 bg-white text-black overflow-y-auto animate-[slideUp_0.3s_ease-out]">
                            <div className="no-print sticky top-0 bg-white/90 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center safe-area-top z-10">
                                <h2 className="text-lg font-bold flex items-center gap-2"><Icons.FileText className="text-[#007AFF]"/> ÏïàÏ†Ñ ÏßÑÎã® Î¶¨Ìè¨Ìä∏</h2>
                                <div className="flex gap-2">
                                    <button onClick={() => window.print()} className="p-2 bg-gray-100 rounded-full"><Icons.Printer size={20}/></button>
                                    <button onClick={() => setShowReport(false)} className="p-2 bg-gray-100 rounded-full"><Icons.X size={20}/></button>
                                </div>
                            </div>
                            <div className="p-6 max-w-3xl mx-auto space-y-6 pb-20">
                                <div className="text-center pb-4 border-b">
                                    <h1 className="text-2xl font-bold">Í±¥ÏÑ§ ÌòÑÏû• AI ÏïàÏ†Ñ ÏßÑÎã®ÏÑú</h1>
                                    <p className="text-gray-500 text-sm mt-1">{new Date().toLocaleString()}</p>
                                </div>
                                {capturedImage && <img src={capturedImage} className="w-full rounded-xl border shadow-sm bg-black object-contain h-64"/>}
                                <div className="prose prose-sm w-full max-w-none bg-gray-50 p-5 rounded-xl border"
                                     dangerouslySetInnerHTML={{ __html: marked.parse(analysisResult || '') }}>
                                </div>
                                <p className="text-center text-xs text-gray-400 mt-8">AI Î∂ÑÏÑù Í≤∞Í≥ºÎäî Ï∞∏Í≥†Ïö©Ïù¥Î©∞, ÏµúÏ¢Ö ÏïàÏ†Ñ Ï±ÖÏûÑÏùÄ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å ÏûàÏäµÎãàÎã§.<br/>Powered by HeavyGuard AI</p>
                            </div>
                        </div>
                    )}

                    {/* API Key Modal */}
                    {isKeyModalOpen && (
                        <div className="absolute inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
                            <div className="ios-glass-dark w-full max-w-xs p-6 rounded-3xl text-center shadow-2xl border border-white/10">
                                <div className="bg-[#007AFF] w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-900/50">
                                    <Icons.Key className="text-white" size={24}/>
                                </div>
                                <h3 className="text-xl font-bold text-white mb-2">ÏÑ§Ï†ï ÌïÑÏöî</h3>
                                <p className="text-sm text-gray-400 mb-4">Google Gemini API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                                
                                <div className="mb-6 bg-white/5 rounded-xl p-3 border border-white/5">
                                    <p className="text-[11px] text-gray-300 mb-2">ÌÇ§Í∞Ä ÏóÜÏúºÏã†Í∞ÄÏöî?</p>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" 
                                       className="block w-full py-2 bg-[#007AFF]/20 text-[#007AFF] rounded-lg text-xs font-bold hover:bg-[#007AFF]/30 transition-colors flex items-center justify-center gap-1">
                                        <span>üîë ÌÇ§ Î¨¥Î£å Î∞úÍ∏âÎ∞õÍ∏∞</span>
                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    </a>
                                    <p className="text-[10px] text-gray-500 mt-2">Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏ ÌõÑ 'Create API key' ÌÅ¥Î¶≠</p>
                                </div>

                                <input type="password" id="apiKeyInput" defaultValue={apiKey} placeholder="API Key ÏûÖÎ†• (AIza...)" 
                                    className="w-full bg-white/10 border border-white/10 rounded-xl p-3 text-white mb-4 outline-none focus:border-[#007AFF] text-center placeholder:text-gray-600 transition-colors text-sm"/>
                                <div className="flex gap-3">
                                    <button onClick={() => setIsKeyModalOpen(false)} className="flex-1 py-3 text-gray-400 text-sm font-medium">Ï∑®ÏÜå</button>
                                    <button onClick={() => { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); setApiKey(document.getElementById('apiKeyInput').value); setIsKeyModalOpen(false); }} 
                                        className="flex-1 py-3 bg-[#007AFF] text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-transform">Ï†ÄÏû•</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
