<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HeavyGuard AI - POSCO E&C RealTime</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Engine -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            overflow: hidden; 
            background-color: black; 
            touch-action: none;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 5rem); } 
        
        /* AR Grid Animation */
        .ar-grid {
            background-image: 
                linear-gradient(rgba(0, 160, 233, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 160, 233, 0.3) 1px, transparent 1px);
            background-size: 40px 40px;
            transform-style: preserve-3d;
            perspective: 500px;
            animation: gridMove 10s linear infinite;
        }
        
        .ar-circle {
            border: 4px dashed rgba(0, 160, 233, 0.6);
            border-radius: 50%;
            transform-style: preserve-3d;
            animation: pulse-border 2s infinite;
        }

        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 40px; }
        }
        
        @keyframes pulse-border {
            0% { border-color: rgba(0, 160, 233, 0.3); box-shadow: 0 0 0 0 rgba(0, 160, 233, 0.2); }
            50% { border-color: rgba(0, 160, 233, 0.8); box-shadow: 0 0 20px 10px rgba(0, 160, 233, 0.1); }
            100% { border-color: rgba(0, 160, 233, 0.3); box-shadow: 0 0 0 0 rgba(0, 160, 233, 0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-anim { animation: fadeInUp 0.3s ease-out forwards; }
        
        /* Zoom Slider */
        input[type=range].zoom-slider {
            -webkit-appearance: none;
            width: 100px; 
            height: 4px;
            background: transparent;
            transform: rotate(-90deg);
            transform-origin: center;
            cursor: pointer;
        }
        input[type=range].zoom-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        input[type=range].zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-top: -7px; 
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- Gemini API ---
        async function callGeminiAPI(prompt, userKey) {
            if (!userKey) return "API 키가 등록되지 않았습니다. 설정에서 키를 등록해주세요.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API 호출 실패: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "죄송합니다. 응답을 생성할 수 없습니다.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "네트워크 오류 또는 잘못된 API 키입니다.";
            }
        }

        // --- Icons ---
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Target = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>;
        const Activity = (p) => <Icon {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></Icon>;
        const Eye = (p) => <Icon {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const AlertTriangle = (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const CheckCircle = (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const Ruler = (p) => <Icon {...p}><path d="M2 12h20"/><path d="M6 12v-2"/><path d="M10 12v-3"/><path d="M14 12v-2"/><path d="M18 12v-3"/></Icon>;
        const Scale = (p) => <Icon {...p}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></Icon>;
        const Wind = (p) => <Icon {...p}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></Icon>;
        const BarChart3 = (p) => <Icon {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Icon>;
        const Zap = (p) => <Icon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>;
        const ShieldCheck = (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></Icon>;
        const RefreshCw = (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></Icon>;
        const CameraIcon = (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>;
        const Maximize = (p) => <Icon {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></Icon>;
        const ScanLine = (p) => <Icon {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></Icon>;
        const FileX = (p) => <Icon {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m14.5 12.5-5 5"/><path d="m9.5 12.5 5 5"/></Icon>;
        const MessageSquare = (p) => <Icon {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></Icon>;
        const Send = (p) => <Icon {...p}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>;
        const CameraOff = (p) => <Icon {...p}><path d="m2 2 20 20"/><path d="M7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16"/><path d="M9.5 4h5L17 7h3a2 2 0 0 1 2 2v7.5"/><path d="M14.121 15.121A3 3 0 1 1 9.88 10.88"/></Icon>;
        const Image = (p) => <Icon {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>;
        const Settings = (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Key = (p) => <Icon {...p}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></Icon>;
        const X = (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const ZoomIn = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></Icon>;
        const Move = (p) => <Icon {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></Icon>;
        const Truck = (p) => <Icon {...p}><path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></Icon>;
        const Tractor = (p) => <Icon {...p}><path d="M3 4h9l1 7"/><path d="M4 11V4"/><path d="M8 10V4"/><path d="M18 5c-.6 0-1 .4-1 1v5.61l-3.23-1.61a.5.5 0 0 0-.46.88l3.69 1.83c.5.25 1 .75 1 1.29V17c0 .55-.45 1-1 1h-6c-.55 0-1-.45-1-1v-2"/><path d="M18 5a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1h-3"/><circle cx="7" cy="15" r="3"/></Icon>;
        const ArrowDownToLine = (p) => <Icon {...p}><path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/></Icon>;
        const Gauge = (p) => <Icon {...p}><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></Icon>;

        const App = () => {
          const [activeMode, setActiveMode] = useState('inspect'); 
          const [inspectionStep, setInspectionStep] = useState('init');
          const [operateStep, setOperateStep] = useState('scan'); 
          
          const [cameraActive, setCameraActive] = useState(false);
          const [cameraError, setCameraError] = useState(null);
          const [simulationMode, setSimulationMode] = useState(false); 
          const [toastMsg, setToastMsg] = useState(null); 
          
          const [zoomLevel, setZoomLevel] = useState(1);

          const [selectedPoint, setSelectedPoint] = useState(null);
          const [diagnosisStatus, setDiagnosisStatus] = useState('ready');
          
          const [activePoints, setActivePoints] = useState([]);
          
          const [angle, setAngle] = useState(0); 
          const [boomLength, setBoomLength] = useState(30); 
          const [isMeasuringBoom, setIsMeasuringBoom] = useState(false); 
          const [load, setLoad] = useState(5.2); 
          const [wind, setWind] = useState(2.4); 
          const [motionScore, setMotionScore] = useState(0);
          
          // Equipment Type State
          const [currentEquip, setCurrentEquip] = useState('crane'); 
          const [isOperateScanning, setIsOperateScanning] = useState(false);

          // Zone Settings
          const [safeRadius, setSafeRadius] = useState(20); 
          
          const [reportData, setReportData] = useState(null);
          const [swayCount, setSwayCount] = useState(0); 
          
          const [apiKey, setApiKey] = useState('');
          const [isKeyModalOpen, setIsKeyModalOpen] = useState(false);
          
          const [messages, setMessages] = useState([
              { role: 'ai', text: '안녕하세요! 포스코이앤씨 안전 AI 비서입니다. 작업 안전 기준이나 장비 점검에 대해 궁금한 점을 물어보세요.' }
          ]);
          const [chatInput, setChatInput] = useState('');
          const [isAiThinking, setIsAiThinking] = useState(false);
          const [aiReportAnalysis, setAiReportAnalysis] = useState(null); 
          const [isGeneratingReport, setIsGeneratingReport] = useState(false);

          const [isIOS, setIsIOS] = useState(false);
          
          const videoRef = useRef(null);
          const canvasRef = useRef(null); 
          const lastFrameData = useRef(null);
          const requestRef = useRef(null);
          const chatEndRef = useRef(null);
          const activeModeRef = useRef(activeMode);
          const operateStepRef = useRef(operateStep);
          const motionScoreRef = useRef(motionScore);

          // API Key Initialization
          useEffect(() => {
              const storedKey = localStorage.getItem('gemini_api_key');
              if (storedKey) setApiKey(storedKey);
              else setTimeout(() => setIsKeyModalOpen(true), 1000);
          }, []);

          const saveApiKey = (key) => {
              localStorage.setItem('gemini_api_key', key);
              setApiKey(key);
              setIsKeyModalOpen(false);
              setToastMsg("API 키가 저장되었습니다.");
              setTimeout(() => setToastMsg(null), 2000);
          };

          const clearApiKey = () => {
              localStorage.removeItem('gemini_api_key');
              setApiKey('');
              setToastMsg("API 키가 삭제되었습니다.");
              setTimeout(() => setToastMsg(null), 2000);
          };

          async function startCamera() {
              setCameraError(null);
              try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error("API Not Available");
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                if (videoRef.current) {
                  videoRef.current.srcObject = stream;
                  setCameraActive(true);
                  setSimulationMode(false); 
                }
              } catch (err) {
                console.warn("Camera Error:", err);
                setCameraActive(false);
                setSimulationMode(true);
                setToastMsg("카메라 권한 문제로 시뮬레이션 모드가 실행됩니다.");
                setTimeout(() => setToastMsg(null), 3000);
              }
          }

          const stopCamera = () => {
              const stream = videoRef.current?.srcObject;
              if (stream && stream.getTracks) {
                  stream.getTracks().forEach(track => track.stop());
              }
          };

          useEffect(() => {
            const checkIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            setIsIOS(checkIOS);
            startCamera();
            
            const handleOrientation = (event) => {
                let beta = event.beta; 
                if (beta === null) return;
                let rawAngle = Math.abs(beta);
                if (rawAngle > 90) rawAngle = 90;
                setAngle(Number(rawAngle.toFixed(1)));
            };
            window.addEventListener('deviceorientation', handleOrientation);
            return () => {
                window.removeEventListener('deviceorientation', handleOrientation);
                stopCamera();
            };
          }, []);

          useEffect(() => {
              if (activeMode === 'chat') {
                  chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
              }
          }, [messages, activeMode]);

          useEffect(() => {
              activeModeRef.current = activeMode;
          }, [activeMode]);

          useEffect(() => {
              operateStepRef.current = operateStep;
          }, [operateStep]);

          useEffect(() => {
              motionScoreRef.current = motionScore;
          }, [motionScore]);

          const handleModeChange = (mode) => {
              setActiveMode(mode);
              // 작업 모드 진입 시 스캔 단계부터 시작하도록 리셋
              if (mode === 'operate') {
                  setOperateStep('scan'); 
              }
          };

          const startOperateScan = () => {
              setIsOperateScanning(true);
              setTimeout(() => {
                  // 장비 인식 시뮬레이션 (랜덤)
                  const equips = ['crane', 'excavator', 'vehicle'];
                  const detected = equips[Math.floor(Math.random() * equips.length)];
                  setCurrentEquip(detected);
                  
                  let equipName = '';
                  if(detected === 'crane') equipName = '크레인/항타기';
                  else if(detected === 'excavator') equipName = '굴삭기';
                  else equipName = '덤프/차량';
                  
                  setToastMsg(`${equipName} 식별 완료.`);
                  setTimeout(() => setToastMsg(null), 3000);
                  
                  setIsOperateScanning(false);
                  setOperateStep('setup'); // 구역 설정 단계로 이동
              }, 2000);
          };

          const processVideo = () => {
              const isOperateActive = activeModeRef.current === 'operate' && operateStepRef.current === 'active';
              if (simulationMode) {
                  if (isOperateActive) {
                      setMotionScore(prev => {
                          const noise = Math.random() * 0.5;
                          const next = Math.random() > 0.95 ? 20 : Math.max(0, prev * 0.9 + noise);
                          motionScoreRef.current = next;
                          return next;
                      });
                      if (motionScoreRef.current > 15) setSwayCount(prev => prev + 0.05);
                  }
                  requestRef.current = requestAnimationFrame(processVideo);
                  return;
              }

              if (!videoRef.current || !canvasRef.current) {
                  return;
              }

              const video = videoRef.current;
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d', { willReadFrequently: true });
              const width = 32; const height = 32;
              if (canvas.width !== width) { canvas.width = width; canvas.height = height; }
              ctx.drawImage(video, 0, 0, width, height);
              
              try {
                  const frame = ctx.getImageData(0, 0, width, height);
                  const data = frame.data;
                  if (lastFrameData.current) {
                      let diff = 0;
                      for (let i = 0; i < data.length; i += 4) { diff += Math.abs(data[i] - lastFrameData.current[i]); }
                      const score = diff / (width * height);
                      setMotionScore(prev => {
                          const next = (prev * 0.8) + (score * 0.2);
                          motionScoreRef.current = next;
                          return next;
                      }); 
                      if (score > 15 && isOperateActive) setSwayCount(prev => prev + 0.05);
                  }
                  lastFrameData.current = data;
              } catch (e) {}
              requestRef.current = requestAnimationFrame(processVideo);
          };

          useEffect(() => {
              if (cameraActive || simulationMode) {
                  requestRef.current = requestAnimationFrame(processVideo);
              } else if (requestRef.current) {
                  cancelAnimationFrame(requestRef.current);
              }
              return () => { if (requestRef.current) cancelAnimationFrame(requestRef.current); };
          }, [cameraActive, simulationMode]);

          const goToReport = () => {
              if (activeMode === 'operate') {
                  const finalSway = Math.floor(swayCount);
                  const safetyScore = Math.max(0, 100 - (finalSway * 5)); 
                  let comment = "안전하게 작업이 완료되었습니다.";
                  if (finalSway > 5) comment = "급조작이 다수 감지되었습니다. 주의가 필요합니다.";
                  else if (finalSway > 2) comment = "약간의 흔들림이 있었습니다.";

                  setReportData({
                      score: safetyScore, swayCount: finalSway, comment: comment,
                      date: new Date().toLocaleTimeString(), stats: { wind, load, boomLength, equip: currentEquip }
                  });
              }
              setActiveMode('report');
          };

          const handleSendMessage = async () => {
              if (!chatInput.trim()) return;
              if (!apiKey) {
                  setMessages(prev => [...prev, { role: 'ai', text: 'API 키가 설정되지 않았습니다. 상단 설정 버튼을 눌러 키를 등록해주세요.' }]);
                  setIsKeyModalOpen(true);
                  return;
              }
              const userMsg = chatInput;
              setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
              setChatInput('');
              setIsAiThinking(true);
              const prompt = `너는 포스코이앤씨 건설현장 안전 관리 AI 비서야. 질문: "${userMsg}" 답변 가이드: 안전 법규 준수, 전문적, 친절함.`;
              const aiResponse = await callGeminiAPI(prompt, apiKey);
              setMessages(prev => [...prev, { role: 'ai', text: aiResponse }]);
              setIsAiThinking(false);
          };

          const generateAIReport = async () => {
              if (!reportData) return;
              if (!apiKey) { setToastMsg("API 키 등록이 필요합니다."); setIsKeyModalOpen(true); return; }
              setIsGeneratingReport(true);
              const prompt = `건설 현장 작업 로그 (${reportData.stats.equip}): 안전점수 ${reportData.score}점, 급조작 ${reportData.swayCount}회. 안전 리포트 작성해줘.`;
              const analysis = await callGeminiAPI(prompt, apiKey);
              setAiReportAnalysis(analysis);
              setIsGeneratingReport(false);
          };

          const radius = useMemo(() => {
              const rad = angle * (Math.PI / 180);
              const r = boomLength * Math.cos(rad);
              return Number(Math.max(0, r).toFixed(1));
          }, [angle, boomLength]);

          const startScan = () => {
              setInspectionStep('scanning');
              setTimeout(() => { 
                  setInspectionStep('mapped'); 
                  setActivePoints([
                    { id: 1, name: '주요 부품 (Main Part)', top: '40%', left: '50%', status: 'danger', issue: '미세 균열 감지됨', criteria: '안전보건규칙 제63조' },
                    { id: 2, name: '유압 실린더 (Cylinder)', top: '60%', left: '45%', status: 'warning', issue: '누유 의심', criteria: '제조사 매뉴얼 점검 기준' },
                  ]);
              }, 2000);
          };
          const resetScan = () => { setInspectionStep('init'); setActivePoints([]); setSelectedPoint(null); };
          const handlePointClick = (p) => { setSelectedPoint(p); setDiagnosisStatus('ready'); };
          const startDiagnosis = () => {
              setDiagnosisStatus('analyzing');
              setTimeout(() => { setDiagnosisStatus('done'); }, 2000);
          };
          const measureBoom = () => {
              setIsMeasuringBoom(true);
              setTimeout(() => {
                  setIsMeasuringBoom(false);
                  setBoomLength(Math.floor(Math.random() * (45 - 25 + 1) + 25));
              }, 3000);
          };
          const enableSimulation = () => { setSimulationMode(true); setCameraError(null); };
          const confirmZone = () => {
              setOperateStep('active');
              const equipName = currentEquip === 'crane' ? '크레인' : currentEquip === 'excavator' ? '굴삭기' : '차량';
              setToastMsg(`${equipName} 작업 반경 ${safeRadius}m 설정 완료.`);
              setTimeout(() => setToastMsg(null), 3000);
          };

          // Render Different HUD based on Equipment Type
          const renderMeasurePanel = () => {
              if (currentEquip === 'crane') {
                  return (
                      <>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase mb-2"><span className="flex items-center gap-1 text-[#00A0E9]"><Ruler size={10}/> 붐 길이 (AI)</span><span className="text-white text-lg">{boomLength}m</span></div>{isMeasuringBoom ? (<div className="h-8 bg-black/40 rounded-lg flex items-center justify-center border border-[#00A0E9] animate-pulse"><span className="text-[10px] text-[#00A0E9] font-bold">Measuring...</span></div>) : (<button onClick={measureBoom} className="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg text-[10px] font-bold flex items-center justify-center gap-1 border border-white/10"><Maximize size={10}/> 붐 길이 측정</button>)}</div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Scale size={10}/> 추정 하중</span><span className="text-white">{load}t</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-green-500 h-full" style={{width: '40%'}}></div></div></div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Wind size={10}/> 현장 풍속</span><span>{wind}m/s</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-blue-400 h-full" style={{width: '20%'}}></div></div></div>
                      </>
                  );
              } else if (currentEquip === 'excavator') {
                  return (
                      <>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase mb-2"><span className="flex items-center gap-1 text-yellow-500"><ArrowDownToLine size={10}/> 굴착 깊이</span><span className="text-white text-lg">3.5m</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-yellow-500 h-full" style={{width: '60%'}}></div></div></div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Scale size={10}/> 버킷 하중</span><span className="text-white">0.8m³</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-orange-500 h-full" style={{width: '70%'}}></div></div></div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Activity size={10}/> 선회 속도</span><span>12rpm</span></div></div>
                      </>
                  );
              } else if (currentEquip === 'vehicle') {
                  return (
                      <>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase mb-2"><span className="flex items-center gap-1 text-green-400"><Gauge size={10}/> 이동 속도</span><span className="text-white text-lg">15km/h</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-green-500 h-full" style={{width: '30%'}}></div></div></div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Maximize size={10}/> 전방 거리</span><span className="text-red-400">4.2m</span></div><div className="w-full bg-white/10 h-1 mt-2 rounded-full overflow-hidden"><div className="bg-red-500 h-full" style={{width: '20%'}}></div></div></div>
                        <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10 w-44"><div className="flex justify-between text-[10px] font-bold uppercase"><span className="flex items-center gap-1"><Scale size={10}/> 적재 중량</span><span>24t</span></div></div>
                      </>
                  );
              }
          };

          return (
            <div className="flex flex-col h-[100dvh] bg-black text-white overflow-hidden relative safe-pb">
              
              {/* API Key Modal */}
              {isKeyModalOpen && (
                  <div className="absolute inset-0 bg-black/90 z-[100] flex flex-col items-center justify-center p-6 animate-in fade-in">
                      <div className="bg-[#1c1c1e] w-full max-w-sm p-6 rounded-2xl border border-white/10 shadow-2xl">
                          <div className="flex items-center justify-between mb-6">
                              <h3 className="text-lg font-bold text-white flex items-center gap-2"><Key size={20} className="text-[#00A0E9]"/> API 키 설정</h3>
                              <button onClick={() => setIsKeyModalOpen(false)} className="text-white/50 hover:text-white"><X size={20}/></button>
                          </div>
                          <p className="text-xs text-white/60 mb-4 leading-relaxed">Gemini AI 기능 사용을 위한 API 키 입력 (브라우저 저장)</p>
                          <input type="password" placeholder="API Key 입력" className="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-white mb-4 focus:border-[#00A0E9] outline-none" defaultValue={apiKey} id="apiKeyInput" />
                          <div className="flex gap-3">
                              {apiKey && <button onClick={clearApiKey} className="flex-1 py-3 bg-red-500/10 text-red-500 rounded-xl font-bold text-sm border border-red-500/20">삭제</button>}
                              <button onClick={() => saveApiKey(document.getElementById('apiKeyInput').value)} className="flex-[2] py-3 bg-[#00A0E9] text-white rounded-xl font-bold text-sm shadow-lg hover:bg-[#008AC9] transition-colors">저장</button>
                          </div>
                      </div>
                  </div>
              )}

              {/* Equipment Rescan Button (Operate Mode Only - Active Step) */}
              {activeMode === 'operate' && operateStep === 'active' && (
                  <div className="absolute top-20 right-4 z-50">
                      <button 
                          onClick={startOperateScan}
                          className="bg-black/60 backdrop-blur-md p-2 rounded-full border border-white/10 shadow-lg text-xs flex items-center gap-1 px-3"
                      >
                          <RefreshCw size={12} className="text-white/70"/> 
                          <span className="text-white/80 font-bold">{currentEquip === 'crane' ? '크레인' : currentEquip === 'excavator' ? '굴삭기' : '차량'}</span>
                      </button>
                  </div>
              )}

              {/* Header */}
              <div className="absolute top-0 w-full p-4 pt-safe z-50 bg-gradient-to-b from-black/90 to-transparent flex justify-between items-center pointer-events-none">
                  <div className="flex items-center gap-2 pointer-events-auto">
                      <div className="w-2 h-2 rounded-full bg-[#00A0E9] shadow-[0_0_8px_#00A0E9]"></div>
                      <h1 className="text-sm font-bold tracking-wider">HeavyGuard <span className="text-[#00A0E9]">AI</span></h1>
                  </div>
                  <div className="flex gap-2 pointer-events-auto">
                      <div className="bg-white/10 px-3 py-1 rounded-full border border-white/5 backdrop-blur-md flex items-center gap-2">
                          <span className="text-[10px] uppercase font-bold text-white/80">
                              {simulationMode ? 'Simulation' : (activeMode === 'operate' ? (operateStep === 'scan' ? 'AI Scan' : operateStep === 'setup' ? 'Zone Setup' : 'Live Sensing') : activeMode === 'inspect' ? 'AI Inspection' : activeMode === 'chat' ? 'Safety Chat' : 'Report')}
                          </span>
                          {isIOS && activeMode === 'operate' && !simulationMode && <span className="text-[8px] bg-[#00A0E9] text-white px-1.5 py-0.5 rounded font-bold tracking-tighter">LiDAR</span>}
                      </div>
                      <button onClick={() => setIsKeyModalOpen(true)} className={`p-1.5 rounded-full border backdrop-blur-md ${apiKey ? 'bg-white/10 border-white/5 text-white/80' : 'bg-red-500/20 border-red-500/50 text-red-400 animate-pulse'}`}><Settings size={14} /></button>
                      {activeMode === 'inspect' && inspectionStep === 'mapped' && <button onClick={resetScan} className="bg-white/10 p-1.5 rounded-full border border-white/5 backdrop-blur-md"><RefreshCw size={14} className="text-white/80"/></button>}
                  </div>
              </div>

              {/* Viewport */}
              <div className="relative flex-1 bg-gray-900 w-full overflow-hidden">
                  {simulationMode ? (
                      <div className="absolute inset-0 bg-cover bg-center opacity-80" style={{ backgroundImage: "url('https://images.unsplash.com/photo-1541888946425-d81bb19480c5?auto=format&fit=crop&q=80&w=1000')" }}></div>
                  ) : (
                      <video ref={videoRef} autoPlay playsInline muted className="absolute inset-0 w-full h-full object-cover opacity-80" style={{ transform: `scale(${zoomLevel})` }}></video>
                  )}
                  
                  {/* Zoom Slider */}
                  {!simulationMode && !cameraError && activeMode !== 'chat' && activeMode !== 'report' && (
                      <div className="absolute right-6 top-1/2 -translate-y-1/2 h-44 bg-black/40 backdrop-blur-md rounded-full w-10 border border-white/10 flex flex-col items-center justify-between z-40 py-4 shadow-lg">
                          <div className="text-white/80 font-bold text-[10px] pointer-events-none">Zoom</div>
                          <div className="flex-1 flex items-center justify-center w-full">
                              <input 
                                  type="range" 
                                  min="1" max="3" step="0.1" 
                                  value={zoomLevel} 
                                  onChange={(e) => setZoomLevel(parseFloat(e.target.value))}
                                  className="zoom-slider bg-white/20 rounded appearance-none"
                              />
                          </div>
                          <span className="text-[9px] font-bold text-white/90 font-mono pointer-events-none">{zoomLevel.toFixed(1)}x</span>
                      </div>
                  )}

                  {toastMsg && <div className="absolute top-20 left-1/2 -translate-x-1/2 bg-white/90 text-black px-4 py-2 rounded-full text-xs font-bold shadow-xl z-[60] animate-in fade-in slide-in-from-top-2 whitespace-nowrap pointer-events-none">{toastMsg}</div>}
                  
                  {cameraError && !simulationMode && (
                      <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-50 p-6 text-center animate-in fade-in">
                          <div className="bg-white/10 p-4 rounded-full mb-4 animate-bounce"><CameraOff size={32} className="text-red-500" /></div>
                          <h2 className="text-xl font-bold mb-2">카메라 권한 필요</h2>
                          <p className="text-sm text-white/60 mb-8 max-w-[250px]">카메라 접근 권한이 필요합니다.<br/>설정에서 허용하거나<br/>시뮬레이션 모드를 사용하세요.</p>
                          <div className="flex flex-col gap-3 w-full max-w-xs">
                              <button onClick={startCamera} className="w-full px-6 py-3 bg-[#00A0E9] rounded-xl font-bold text-sm hover:bg-[#008AC9] transition-colors shadow-lg">권한 재요청</button>
                              <button onClick={enableSimulation} className="w-full px-6 py-3 bg-white/10 rounded-xl font-bold text-sm hover:bg-white/20 transition-colors text-white/80 flex items-center justify-center gap-2 border border-white/5"><Image size={16}/> 시뮬레이션 모드</button>
                          </div>
                      </div>
                  )}
                  
                  {/* Mode 1: INSPECT */}
                  {activeMode === 'inspect' && !cameraError && (
                      <div className="absolute inset-0 pb-24">
                          {inspectionStep === 'init' && (
                              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/40 backdrop-blur-sm p-6 text-center animate-in fade-in">
                                  <div className="w-64 h-64 border-[1px] border-white/20 rounded-[40px] flex items-center justify-center relative overflow-hidden mb-6">
                                      <div className="absolute inset-0 bg-gradient-to-b from-[#00A0E9]/0 via-[#00A0E9]/30 to-[#00A0E9]/0 animate-[scan_2s_infinite]"></div>
                                      <Target size={48} className="text-white/40" />
                                  </div>
                                  <div className="space-y-4 flex flex-col items-center">
                                      <div><h2 className="text-xl font-light mb-1">AI 장비 자동 인식</h2><p className="text-xs text-white/60 whitespace-nowrap">현장의 모든 건설기계 및 장비를 자동으로 식별합니다.</p></div>
                                      <button onClick={startScan} className="bg-[#00A0E9] hover:bg-[#008AC9] text-white px-8 py-3 rounded-2xl font-bold text-sm shadow-[0_4px_20px_rgba(0,160,233,0.3)] transition-transform active:scale-95 whitespace-nowrap flex items-center gap-2 mt-4"><Search size={16}/> AI 스마트 스캔 시작</button>
                                  </div>
                              </div>
                          )}
                          {inspectionStep === 'scanning' && (<div className="absolute inset-0 flex flex-col items-center justify-center bg-black/20 backdrop-blur-[2px]"><div className="w-20 h-20 border-4 border-[#00A0E9] border-t-transparent rounded-full animate-spin relative"><div className="absolute inset-0 flex items-center justify-center"><Eye size={24} className="text-[#00A0E9] animate-pulse"/></div></div><p className="mt-6 text-sm font-bold text-white tracking-widest animate-pulse">AI ANALYZING...</p></div>)}
                          {inspectionStep === 'mapped' && activePoints.map(p => (
                              <div key={p.id} style={{top: p.top, left: p.left}} className="absolute transform -translate-x-1/2 -translate-y-1/2 z-10 animate-[bounce_2s_infinite]"><button onClick={() => handlePointClick(p)} className={`w-14 h-14 rounded-full flex items-center justify-center backdrop-blur-md border-2 shadow-lg transition-transform active:scale-90 ${p.status === 'danger' ? 'bg-red-500/30 border-red-500' : 'bg-yellow-500/30 border-yellow-500'}`}><Search size={24} className="text-white"/></button><div className="absolute top-16 left-1/2 -translate-x-1/2 bg-black/80 px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap border border-white/20 backdrop-blur-md">{p.name}</div></div>
                          ))}
                          {selectedPoint && (
                              <div className="absolute inset-0 bg-black/60 backdrop-blur-md z-30 flex items-end pb-24" onClick={() => setSelectedPoint(null)}>
                                  <div className="bg-[#1c1c1e] w-full p-6 rounded-t-[2rem] shadow-2xl border-t border-white/10 animate-[slideUp_0.3s_ease-out]" onClick={(e) => e.stopPropagation()}>
                                      <div className="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-6"></div>
                                      <div className="flex items-start justify-between mb-6"><div><span className="text-[#00A0E9] text-[10px] font-bold tracking-widest uppercase mb-1 block">Component Inspection</span><h3 className="text-2xl font-bold text-white">{selectedPoint.name}</h3></div><div className="p-3 bg-white/5 rounded-full border border-white/10"><Target size={20} className="text-white/80"/></div></div>
                                      {diagnosisStatus === 'ready' && (<div className="space-y-4"><div className="bg-white/5 p-5 rounded-2xl border border-white/5"><div className="flex items-center gap-2 mb-2 text-white/60"><ShieldCheck size={14} /><span className="text-xs font-bold uppercase">Safety Criteria (점검 기준)</span></div><p className="text-sm leading-relaxed font-medium text-white/90 break-keep">"{selectedPoint.criteria}"</p></div><button onClick={startDiagnosis} className="w-full py-4 bg-[#00A0E9] text-white font-bold rounded-2xl active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2"><Zap size={18} fill="currentColor"/> AI 정밀 진단 시작</button></div>)}
                                      {diagnosisStatus === 'analyzing' && (<div className="py-10 flex flex-col items-center justify-center space-y-4"><div className="w-12 h-12 border-4 border-[#00A0E9] border-t-transparent rounded-full animate-spin"></div><p className="text-sm font-bold text-[#00A0E9] animate-pulse">이미지 정밀 분석 중...</p></div>)}
                                      {diagnosisStatus === 'done' && (<div className="space-y-4 animate-[slideInRight_0.3s_ease-out]"><div className={`p-5 rounded-2xl border flex items-center gap-4 ${selectedPoint.status === 'danger' ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'}`}><div className={`p-3 rounded-full ${selectedPoint.status === 'danger' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-black'}`}><AlertTriangle size={24} /></div><div><p className={`text-xs font-bold uppercase ${selectedPoint.status === 'danger' ? 'text-red-400' : 'text-yellow-400'}`}>AI Diagnosis Result</p><p className="text-lg font-bold text-white">{selectedPoint.issue}</p></div></div><div className="flex gap-3"><button onClick={() => setSelectedPoint(null)} className="flex-1 py-4 bg-white/10 text-white font-bold rounded-2xl">닫기</button><button onClick={() => handleModeChange('operate')} className="flex-1 py-4 bg-white text-black font-bold rounded-2xl shadow-lg">작업 모드로 이동</button></div></div>)}
                                  </div>
                              </div>
                          )}
                      </div>
                  )}

                  {/* Mode 2: OPERATE */}
                  {activeMode === 'operate' && (cameraActive || simulationMode) && (
                      <div className="absolute inset-0 pb-24 pointer-events-none">
                          {/* Step 0: Scan (Initial) */}
                          {operateStep === 'scan' && (
                              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60 z-20 p-6 animate-in fade-in pointer-events-auto">
                                  <div className="w-64 h-64 border-[1px] border-white/20 rounded-[40px] flex items-center justify-center relative overflow-hidden mb-6">
                                      <div className="absolute inset-0 bg-gradient-to-b from-[#00A0E9]/0 via-[#00A0E9]/30 to-[#00A0E9]/0 animate-[scan_2s_infinite]"></div>
                                      <Target size={48} className="text-white/40" />
                                  </div>
                                  
                                  <div className="text-center">
                                      {isOperateScanning ? (
                                          <div className="space-y-4">
                                              <div className="w-12 h-12 border-4 border-[#00A0E9] border-t-transparent rounded-full animate-spin mx-auto"></div>
                                              <p className="text-sm font-bold text-[#00A0E9] animate-pulse">AI가 작업 장비를 식별 중입니다...</p>
                                          </div>
                                      ) : (
                                          <div className="space-y-4">
                                              <div>
                                                  <h2 className="text-xl font-light mb-1">작업 장비 스캔</h2>
                                                  <p className="text-xs text-white/60">작업할 장비를 비추면 AI가 자동으로 식별합니다.</p>
                                              </div>
                                              <button 
                                                  onClick={startOperateScan}
                                                  className="bg-[#00A0E9] hover:bg-[#008AC9] text-white px-8 py-3 rounded-2xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 w-full max-w-[200px] mx-auto"
                                              >
                                                  <Search size={16}/> 장비 스캔 시작
                                              </button>
                                          </div>
                                      )}
                                  </div>
                              </div>
                          )}

                          {/* Step 1: Zone Setup */}
                          {operateStep === 'setup' && (
                              <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60 z-20 p-6 animate-in fade-in pointer-events-auto">
                                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-80">
                                      <div className="ar-circle" style={{ width: `${Math.min(safeRadius * 10, 300)}px`, height: `${Math.min(safeRadius * 10, 300)}px` }}></div>
                                      <div className="absolute text-[#00A0E9] font-bold text-sm bg-black/50 px-2 py-1 rounded">R: {safeRadius}m</div>
                                  </div>
                                  <div className="absolute bottom-32 w-full max-w-sm bg-[#1c1c1e] p-6 rounded-[2rem] border border-white/10 shadow-2xl">
                                      <div className="flex items-center gap-3 mb-6">
                                          <div className="p-3 bg-[#00A0E9]/20 rounded-full text-[#00A0E9]"><Move size={20}/></div>
                                          <div><h3 className="text-lg font-bold text-white">작업 구역 설정 (AR)</h3><p className="text-xs text-white/50">안전 작업 반경을 설정해주세요.</p></div>
                                      </div>
                                      <div className="mb-6"><div className="flex justify-between text-xs font-bold text-white/80 mb-2"><span>반경 (Radius)</span><span className="text-[#00A0E9]">{safeRadius}m</span></div><input type="range" min="5" max="50" step="1" value={safeRadius} onChange={(e) => setSafeRadius(parseFloat(e.target.value))} className="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-[#00A0E9]"/></div>
                                      <button onClick={confirmZone} className="w-full py-4 bg-[#00A0E9] text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2"><CheckCircle size={18}/> 설정 완료 및 작업 시작</button>
                                  </div>
                              </div>
                          )}

                          {/* Step 2: Active Monitoring */}
                          {operateStep === 'active' && (
                              <div className="absolute inset-0 pointer-events-none">
                                  <div className="absolute bottom-0 w-full h-1/2 overflow-hidden opacity-40">
                                      <div className="ar-grid w-full h-full origin-bottom" style={{ transform: `rotateX(60deg) scale(${1 + safeRadius/50})` }}></div>
                                      <div className="absolute bottom-10 left-1/2 -translate-x-1/2 text-[10px] text-[#00A0E9] font-bold tracking-widest uppercase">Safe Zone: {safeRadius}m Radius</div>
                                  </div>
                                  {radius > safeRadius && (
                                      <div className="absolute inset-0 border-[10px] border-red-500/50 animate-pulse z-10 flex items-center justify-center">
                                          <div className="bg-red-500 text-white px-6 py-3 rounded-full font-bold shadow-xl flex items-center gap-2"><AlertTriangle size={24}/> 경고: 작업 반경 이탈!</div>
                                      </div>
                                  )}
                                  
                                  {/* HUD: Left (Angle/Radius) - Crane Only or Common? */}
                                  <div className="absolute top-24 left-4 pointer-events-auto">
                                      <div className="bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10 w-40 mb-2"><div className="flex items-center gap-2 mb-1 opacity-70"><Activity size={12} className="text-[#00A0E9]" /><span className="text-[10px] font-bold uppercase">붐 각도</span></div><div className="text-3xl font-light tracking-tighter">{angle}°</div></div>
                                      <div className="bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10 w-40"><div className="flex items-center gap-2 mb-1 opacity-70"><Ruler size={12} className="text-green-400" /><span className="text-[10px] font-bold uppercase">작업 반경</span></div><div className={`text-3xl font-light tracking-tighter ${radius > safeRadius ? 'text-red-500' : 'text-green-400'}`}>{radius}m</div><div className="text-[9px] text-white/40 mt-1 flex items-center gap-1"><Scale size={9}/> AR Calculation</div></div>
                                  </div>
                                  
                                  {/* HUD: Right (Dynamic based on Equipment) */}
                                  <div className="absolute top-24 right-4 pointer-events-auto space-y-2">
                                      {renderMeasurePanel()}
                                  </div>
                                  
                                  {/* LiDAR UI */}
                                  {isMeasuringBoom && (<div className="absolute inset-0 flex items-center justify-center pointer-events-none">{isIOS && !simulationMode ? (<div className="w-full h-full flex items-center justify-center relative"><div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_rgba(0,160,233,0.2)_1px,_transparent_1px)] bg-[length:20px_20px] animate-pulse opacity-50"></div><div className="relative w-72 h-72 border-2 border-[#00A0E9] rounded-lg flex items-center justify-center"><ScanLine size={300} className="text-[#00A0E9]/30 absolute animate-pulse"/><p className="absolute -bottom-10 text-xs font-bold text-[#00A0E9] bg-black/60 px-3 py-1 rounded-full border border-[#00A0E9]/30">LiDAR Precision Scan Active</p></div></div>) : (<div className="relative w-64 h-64 border border-[#00A0E9]/50 rounded-lg flex items-center justify-center"><div className="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#00A0E9]"></div><div className="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#00A0E9]"></div><div className="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#00A0E9]"></div><div className="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#00A0E9]"></div><div className="w-2 h-2 bg-[#00A0E9] rounded-full animate-ping"></div><p className="absolute -bottom-8 text-xs font-bold text-[#00A0E9] bg-black/50 px-2 py-1 rounded">붐 끝단을 중앙에 맞추세요</p></div>)}</div>)}
                                  
                                  {/* Sway Indicator */}
                                  <div className="absolute bottom-36 left-6 right-6"><div className="bg-black/40 backdrop-blur-xl rounded-2xl border border-white/10 p-4"><div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold uppercase flex items-center gap-2"><Eye size={12} className={motionScore > 10 ? "text-red-500" : "text-white"}/> AI 흔들림 감지</span><span className={`text-xs font-bold ${motionScore > 10 ? "text-red-500 animate-pulse" : "text-white/50"}`}>{motionScore > 10 ? "흔들림 감지됨" : "안정 상태"}</span></div><div className="h-2 w-full bg-white/10 rounded-full overflow-hidden flex items-center"><div className={`h-full transition-all duration-100 ${motionScore > 15 ? 'bg-red-500' : 'bg-[#00A0E9]'}`} style={{ width: `${Math.min(motionScore * 5, 100)}%` }}></div></div></div></div>
                              </div>
                          )}
                      </div>
                  )}

                  {/* Mode 3: REPORT */}
                  {activeMode === 'report' && (
                       <div className="absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col p-6 animate-in slide-in-from-right overflow-y-auto pb-32">
                          <div className="flex justify-between items-center mb-8 mt-10"><h2 className="text-2xl font-light text-white">작업 리포트</h2><button onClick={() => handleModeChange('inspect')} className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">✕</button></div>
                          {reportData ? (
                              <div className="space-y-6">
                                <div className="bg-gradient-to-br from-[#00A0E9] to-[#0077b6] p-8 rounded-[32px] mb-6 shadow-2xl relative overflow-hidden"><div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div><p className="text-white/80 font-medium mb-1">안전 숙련도 점수</p><div className="flex items-baseline gap-1"><span className="text-5xl font-bold">{reportData.score}</span><span className="text-xl text-white/60">/100</span></div><p className="text-xs text-white/50 mt-2 text-right">측정 시간: {reportData.date}</p></div>
                                <div className="bg-white/5 rounded-[24px] p-6 border border-white/5"><div className="flex items-center gap-2 mb-4 text-[#00A0E9] font-bold text-sm"><Activity size={16}/> 시스템 기본 분석</div><p className="text-sm text-white/90 leading-relaxed font-medium">{reportData.comment}</p><div className="mt-4 flex gap-2"><span className="bg-black/30 px-3 py-1 rounded-lg text-xs text-white/60">급조작 {Math.floor(reportData.swayCount)}회</span><span className="bg-black/30 px-3 py-1 rounded-lg text-xs text-white/60">풍속 {reportData.stats.wind}m/s</span></div></div>
                                <div className="bg-gradient-to-b from-[#00A0E9]/10 to-transparent rounded-[24px] p-6 border border-[#00A0E9]/20"><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2 text-white font-bold text-sm"><Sparkles size={16} className="text-[#00A0E9]" /> Gemini AI 정밀 분석</div>{!aiReportAnalysis && !isGeneratingReport && (<button onClick={generateAIReport} className="text-[10px] bg-[#00A0E9] px-3 py-1.5 rounded-full font-bold shadow-lg active:scale-95 transition-transform">분석 시작</button>)}</div>{isGeneratingReport ? (<div className="flex flex-col items-center py-4 gap-3"><div className="w-6 h-6 border-2 border-[#00A0E9] border-t-transparent rounded-full animate-spin"></div><p className="text-xs text-[#00A0E9] animate-pulse">Gemini가 리포트를 분석 중입니다...</p></div>) : aiReportAnalysis ? (<div className="text-sm text-white/90 leading-relaxed whitespace-pre-wrap animate-in fade-in">{aiReportAnalysis}</div>) : (<p className="text-xs text-white/40">버튼을 눌러 작업 내용에 대한 AI의 상세 피드백을 받아보세요.</p>)}</div>
                              </div>
                          ) : (
                              <div className="flex-1 flex flex-col items-center justify-center text-center opacity-60"><FileX size={48} className="text-white/40 mb-4"/><p className="text-lg font-bold">작업 이력이 없습니다</p><p className="text-xs text-white/60 mt-2">'작업(Live)' 모드에서 안전 관제를 진행하면<br/>자동으로 리포트가 생성됩니다.</p><button onClick={() => handleModeChange('operate')} className="mt-8 px-6 py-3 bg-white/10 rounded-full text-xs font-bold hover:bg-white/20">작업 모드로 이동</button></div>
                          )}
                       </div>
                  )}

                  {/* Mode 4: AI CHAT */}
                  {activeMode === 'chat' && (
                      <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex flex-col pt-safe animate-in slide-in-from-right z-[60]">
                          <div className="p-4 border-b border-white/10 flex items-center justify-between bg-black/50">
                              <div className="flex items-center gap-2"><div className="p-2 bg-[#00A0E9]/20 rounded-full"><Sparkles size={18} className="text-[#00A0E9]"/></div><div><h2 className="text-sm font-bold text-white">AI 안전 비서</h2><p className="text-[10px] text-white/50">Powered by Gemini 1.5</p></div></div>
                              <button onClick={() => handleModeChange('inspect')} className="p-2 rounded-full hover:bg-white/10"><FileX size={18} className="text-white/60"/></button>
                          </div>
                          <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
                              {messages.map((msg, idx) => (<div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} msg-anim`}><div className={`max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-[#00A0E9] text-white rounded-br-none' : 'bg-white/10 text-white/90 rounded-bl-none border border-white/5'}`}>{msg.text}</div></div>))}
                              {isAiThinking && (<div className="flex justify-start msg-anim"><div className="bg-white/5 px-4 py-3 rounded-2xl rounded-bl-none flex gap-1 items-center border border-white/5"><div className="w-1.5 h-1.5 bg-[#00A0E9] rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-[#00A0E9] rounded-full animate-bounce delay-100"></div><div className="w-1.5 h-1.5 bg-[#00A0E9] rounded-full animate-bounce delay-200"></div></div></div>)}
                              <div ref={chatEndRef}></div>
                          </div>
                          <div className="p-4 bg-black border-t border-white/10 safe-pb">
                              <div className="flex gap-2 items-center bg-white/10 p-1.5 rounded-full border border-white/10 pl-4 focus-within:border-[#00A0E9] transition-colors"><input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="안전 규정이나 장비에 대해 물어보세요..." className="flex-1 bg-transparent text-sm text-white placeholder-white/40 focus:outline-none"/><button onClick={handleSendMessage} disabled={!chatInput.trim() || isAiThinking} className={`p-2.5 rounded-full transition-all ${chatInput.trim() ? 'bg-[#00A0E9] text-white' : 'bg-white/5 text-white/20'}`}><Send size={16} /></button></div>
                          </div>
                      </div>
                  )}

              </div>

              {/* Bottom Nav: Safe Area applied, 4 Tabs - Hidden in Chat Mode */}
              {activeMode !== 'chat' && (
                <div className="absolute bottom-[calc(env(safe-area-inset-bottom)+1rem)] left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur-xl p-1.5 rounded-full border border-white/10 flex gap-1 shadow-2xl z-50">
                    <NavBtn icon={<Eye size={20}/>} label="점검" active={activeMode === 'inspect'} onClick={() => handleModeChange('inspect')} />
                    <NavBtn icon={<Activity size={20}/>} label="작업" active={activeMode === 'operate'} onClick={() => handleModeChange('operate')} />
                    <NavBtn icon={<BarChart3 size={20}/>} label="리포트" active={activeMode === 'report'} onClick={goToReport} />
                    <NavBtn icon={<MessageSquare size={20}/>} label="AI 비서" active={activeMode === 'chat'} onClick={() => handleModeChange('chat')} />
                </div>
              )}
            </div>
          );
        };

        const NavBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-14 h-14 rounded-full flex flex-col items-center justify-center gap-0.5 transition-all ${active ? 'bg-white text-black' : 'text-white/50 hover:bg-white/10'}`}>
                {icon}<span className="text-[11px] font-bold">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
